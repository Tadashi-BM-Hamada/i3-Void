"use strict";importScripts("/assets/workbox-77b0e3e0dd4773bcd6c7e74f302f7c69/workbox-sw.js"),workbox.setConfig({modulePathPrefix:"/assets/workbox-77b0e3e0dd4773bcd6c7e74f302f7c69",debug:!1});var authUrls=["auth","session/sso_login","session/sso","srv/status"].map((e=>`/${e}`)),chatRegex=/\/chat\/channel\/(\d+)\//,inlineReplyIcon="https://forum.endeavouros.com/images/push-notifications/inline_reply.png";const oldCacheNames=["discourse-1","external-1"];oldCacheNames.forEach((e=>caches.delete(e)));var cacheVersion="2",discourseCacheName="discourse-"+cacheVersion,externalCacheName="external-"+cacheVersion;const expirationOptions={maxAgeSeconds:604800,maxEntries:250,purgeOnQuotaError:!0,matchOptions:{ignoreVary:!0}};var chromeVersionMatch=navigator.userAgent.match(/Chrome\/97.0.(\d+)/),isBrokenChrome97=chromeVersionMatch&&parseInt(chromeVersionMatch[1])<=4692,isApple=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);workbox.routing.registerRoute((function(e){return e.url.origin===location.origin&&!authUrls.some((t=>e.url.pathname.startsWith(t)))&&!isBrokenChrome97&&!isApple}),new workbox.strategies.NetworkFirst({cacheName:discourseCacheName,plugins:[new workbox.cacheableResponse.CacheableResponsePlugin({statuses:[200]}),new workbox.expiration.ExpirationPlugin(expirationOptions)]}));var cdnUrls=[];workbox.routing.registerRoute((function(e){return e.url.origin!==location.origin&&0===cdnUrls.filter((function(t){return e.url.href.startsWith(t)})).length}),new workbox.strategies.NetworkFirst({cacheName:externalCacheName,plugins:[new workbox.cacheableResponse.CacheableResponsePlugin({statuses:[200]}),new workbox.expiration.ExpirationPlugin(expirationOptions)]}));var idleThresholdTime=1e4,lastAction=-1;function isIdle(){return lastAction+idleThresholdTime<Date.now()}function showNotification(e,t,o,n,i,s,r){var a={body:t,icon:o,badge:n,data:{url:r,baseUrl:s},tag:i};return chatRegex.test(r)&&(a.actions=[{action:"reply",title:"Reply",placeholder:"reply",type:"text",icon:inlineReplyIcon}]),self.registration.showNotification(e,a)}self.addEventListener("push",(function(e){var t=e.data.json();if(!isIdle()&&t.hide_when_active)return!1;e.waitUntil(self.registration.getNotifications({tag:t.tag}).then((function(e){return e&&e.length>0&&e.forEach((function(e){e.close()})),showNotification(t.title,t.body,t.icon,t.badge,t.tag,t.base_url,t.url)})))})),self.addEventListener("notificationclick",(function(e){e.notification.close();var t=e.notification.data.url,o=e.notification.data.baseUrl;if("reply"===e.action){let n;fetch("/session/csrf",{credentials:"include",headers:{Accept:"application/json"}}).then((e=>{if(!e.ok)throw new Error("Network response was not OK");return e.json()})).then((i=>{n=i.csrf;let s=t.match(chatRegex);if(s.length>0){let t=s[1];fetch(`${o}/chat/${t}.json`,{credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-CSRF-Token":n},body:`message=${e.reply}`,method:"POST",mode:"cors"})}}))}else e.waitUntil(clients.matchAll({type:"window"}).then((function(e){if(!e.some((function(e){return e.url===o+t&&"focus"in e?(e.focus(),!0):"postMessage"in e&&"focus"in e&&(e.focus(),e.postMessage({url:t}),!0)}))&&clients.openWindow)return clients.openWindow(o+t)})))})),self.addEventListener("message",(function(e){"lastAction"in e.data&&(lastAction=e.data.lastAction)})),self.addEventListener("pushsubscriptionchange",(function(e){e.waitUntil(Promise.all(fetch("https://forum.endeavouros.com/push_notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:new URLSearchParams({"subscription[endpoint]":e.newSubscription.endpoint,"subscription[keys][auth]":e.newSubscription.toJSON().keys.auth,"subscription[keys][p256dh]":e.newSubscription.toJSON().keys.p256dh,send_confirmation:!1})}),fetch("https://forum.endeavouros.com/push_notifications/unsubscribe",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:new URLSearchParams({"subscription[endpoint]":e.oldSubscription.endpoint,"subscription[keys][auth]":e.oldSubscription.toJSON().keys.auth,"subscription[keys][p256dh]":e.oldSubscription.toJSON().keys.p256dh})})))}));
//# sourceMappingURL=/assets/service-worker-70b59ba8cdf1ef9d75cda7ee107878928da3ee2b7ffe088a5b0ee756892ef9ca.js.map